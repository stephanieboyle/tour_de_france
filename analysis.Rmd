---
title: " "
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align = "center")
```


```{r, echo=FALSE, out.width='40%'}
knitr::include_graphics("images/logo.jpeg")
```


```{r, eval = FALSE}
library(colorfindr)
library(tidyverse)

# Get colors and create a palette with n = 5 
tdf_colors <- get_colors("~/Desktop/image.jpeg") %>% # you can reference a local file on your computer or a jpg web address
  make_palette(n = 10) # here we extract 5 colors

tdf_colors
```


# Tour de France Analysis 

<br>

If you know me, you know I'm a huge cycling fan. So when I saw this TidyTuesday dataset come up, I was sold. 


## Data Exploration


Let's load our libraries and get the data in to see what it looks like. 


```{r, warning = FALSE, message = FALSE}
library(tidyverse)
library(here)
library(janitor)

# read the data in 
# tdf_winners <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-04-07/tdf_winners.csv')
# 

tdf <- tidytuesdayR::tt_load('2020-04-07')
tdf_stage_wins <- tdf$stage_data %>% clean_names()
tdf_stages <- tdf$tdf_stages %>% clean_names()
tdf_winners <- tdf$tdf_winners %>% clean_names()

rm(tdf)
```

So, we have three datasets:

The `tdf_winners` data contains information about the different people who took part. It's not very big, as it has `106` rows, and `19` columns. 

```{r}
head(tdf_winners)
```

The `tdf_stage_wins` contains more detailed information about each year's race. It has information about who won each stage, what time the rider achieved, and how many points they gained. 

```{r}
tdf_stage_wins
```

The `tdf_stages` data contains information about the stage itself, such as the distance, type of stage, and destination. 


```{r}
tdf_stages
```


# TDF Winners Dataset


## Number of unique race winners and teams

```{r}
tdf_winners %>%
  summarise(winner_count = n_distinct(winner_name), 
            team_count = n_distinct(winner_team))


```

only 63 cyclists, but 106 editions. So some cyclists have won multiple. And only 48 different teams. 


## Top cyclists


```{r}
winners <- tdf_winners %>% 
  group_by(winner_name) %>%
  summarise(count = n()) %>%
  arrange(desc(count))

winners
```

```{r}

winners %>%
 head(15) %>%
ggplot() + 
  aes(x = reorder(winner_name, count), y = count) + 
  geom_col(fill = "#ECC615") + 
  coord_flip() + 
  ylab("\n Number of TdF wins") + xlab(" ")
```


```{r}
tdf_winners %>% 
  group_by(winner_team) %>%
  summarise(count = n()) %>%
  arrange(desc(count))
```


## Most stage wins

```{r}
stage_wins <- tdf_winners %>%
  group_by(winner_name) %>%
  summarise(totals = sum(stage_wins)) %>%
  arrange(desc(totals))

stage_wins %>%
  head(15) %>%
ggplot() + 
  aes(reorder(winner_name,totals), totals) + 
  geom_col(fill = "#067F0C") + 
  coord_flip() + 
  xlab(" ") + ylab("\n Number of stage wins")
```

```{r}
stage_leads <- tdf_winners %>%
  group_by(winner_name) %>%
  summarise(totals = sum(stages_led)) %>%
  arrange(desc(totals))

stage_leads %>%
  head(15) %>%
ggplot() + 
  aes(reorder(winner_name,totals), totals) + 
  geom_col(fill = "#067F0C") + 
  coord_flip() + 
  xlab(" ") + ylab("\n Number of stage leads")
```




# Countries with most winners

```{r}
tdf_winners %>%
  group_by(nationality) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  ggplot(aes(x = reorder(nationality,count), y = count)) + 
  geom_col(fill = "red") + 
  coord_flip() + 
  xlab(" ") + ylab("Number of winners from each country")
```

# race distances over time

```{r}
library(lubridate)

tdf_winners <- tdf_winners %>% 
  mutate(year = lubridate::year(start_date)) %>%
  select(-c(full_name,nickname, birth_town))
  
tdf_winners %>%
  ggplot(aes(x = year, y = distance)) + 
  geom_line(color = "#067F0C") + 
  xlab("\n Race Year") + ylab("Distance (km) \n")
```

```{r}
tdf_winners %>%
  filter(distance == max(distance) | distance == min(distance)) %>%
  select(year, distance, winner_name)

```

```{r}
tdf_winners %>%
  ggplot(aes(year, time_overall)) + 
  geom_line(color = "red") + 
  xlab("Race Year") + ylab("Overall Time")
```

```{r}
tdf_winners %>%
  drop_na(time_overall) %>%
  filter(time_overall == min(time_overall) | time_overall == max(time_overall))
```

```{r, warning = FALSE, message = FALSE}
tdf_winners %>%
  mutate(speed = distance / time_overall) %>%
  ggplot() + 
  aes(x = year, y = speed) + 
  geom_point(color = "Red") + 
  geom_smooth(color = "#ECC615", level = FALSE)
```


# Stages


```{r}
tdf_stages <- tdf_stages %>%
  mutate(year = lubridate::year(date), 
         type = str_to_lower(type))

tdf_stages
```

```{r}
tdf_stages %>% 
  group_by(type) %>%
  summarise(totals = n()) %>%
  arrange(desc(totals)) %>%
  ggplot(aes(x = reorder(type,totals), y = totals)) + 
  geom_col(fill = "red") + 
  coord_flip() + 
  xlab("") + ylab("\n number of stage types")
```


```{r}
# tdf_stages %>%
#   group_by(winner) %>%
#   mutate(totals = n()) %>% 
#   ungroup() %>%
#   arrange(desc(totals)) %>%
#   select(winner, type, totals) %>%
#   group_by(winner,type) %>%
#   summarise(totals_all = sum(totals)) %>%
#   arrange(desc(totals_all))

# %>%
#   distinct()
#   head(15) %>% 
#   ungroup() %>%
#   ggplot(aes(x = reorder(winner, totals), y = totals, fill = type)) +
#   geom_col()



tdf_stages %>%
  group_by(winner, type) %>%
  summarise(totals = n()) %>%
  arrange(desc(totals))


tdf_stages %>% 
  select(winner, type) %>%
  group_by(winner) %>% 
  mutate(totals = n()) %>% 
  ungroup() %>% 
  mutate(top_winners = fct_lump(winner, 30)) %>% 
  count(top_winners, type, totals, sort = TRUE) %>%
  filter(top_winners != "Other") %>% 
  ggplot(aes(x = fct_reorder(winner_lmp, total_stage_wins), y = n, fill = Type)) +
  geom_col() + 
  coord_flip() +
  scale_fill_viridis_d() +
  labs(x = NULL)


```


```{r}
tdf_stages %>% 
  select(winner, type) %>%
  group_by(winner) %>% 
  mutate(totals = n()) %>% 
  ungroup() %>% 
  filter(totals >= 10) %>% 
  # count(winner, type, totals, sort = TRUE) %>%
  arrange(winner) %>%
  distinct() %>%
  arrange(desc(totals)) %>%
ggplot(aes(x = reorder(winner, totals), y = totals, fill = type)) +
  geom_col() + 
  coord_flip() 
```

